/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function t(t,e){var n="function"==typeof Symbol&&t[Symbol.iterator];if(!n)return t;var a,r,i=n.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(a=i.next()).done;)o.push(a.value)}catch(t){r={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return o}var e;!function(t){t[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Stopped=2]="Stopped"}(e||(e={}));var n={type:"xstate.init"};function a(t){return void 0===t?[]:[].concat(t)}function r(t){return{type:"xstate.assign",assignment:t}}function i(t,e){return"string"==typeof(t="string"==typeof t&&e&&e[t]?e[t]:t)?{type:t}:"function"==typeof t?{type:t.name,exec:t}:t}function o(t){return function(e){return t===e}}function s(t){return"string"==typeof t?{type:t}:t}function c(t,e){return{value:t,context:e,actions:[],changed:!1,matches:o(t)}}function u(t,e,n){var a=e,r=!1;return[t.filter((function(t){if("xstate.assign"===t.type){r=!0;var e=Object.assign({},a);return"function"==typeof t.assignment?e=t.assignment(a,n):Object.keys(t.assignment).forEach((function(r){e[r]="function"==typeof t.assignment[r]?t.assignment[r](a,n):t.assignment[r]})),a=e,!1}return!0})),a,r]}function l(e,r){void 0===r&&(r={});var l=t(u(a(e.states[e.initial].entry).map((function(t){return i(t,r.actions)})),e.context,n),2),d=l[0],m=l[1],f={config:e,_options:r,initialState:{value:e.initial,actions:d,context:m,matches:o(e.initial)},transition:function(n,r){var l,d,m="string"==typeof n?{value:n,context:e.context}:n,p=m.value,T=m.context,v=s(r),g=e.states[p];if(g.on){var y=a(g.on[v.type]);try{for(var k=function(t){var e="function"==typeof Symbol&&Symbol.iterator,n=e&&t[e],a=0;if(n)return n.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&a>=t.length&&(t=void 0),{value:t&&t[a++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}(y),S=k.next();!S.done;S=k.next()){var E=S.value;if(void 0===E)return c(p,T);var I="string"==typeof E?{target:E}:E,h=I.target,x=I.actions,R=void 0===x?[]:x,A=I.cond,_=void 0===A?function(){return!0}:A,b=void 0===h,P=null!=h?h:p,B=e.states[P];if(_(T,v)){var O=t(u((b?a(R):[].concat(g.exit,R,B.entry).filter((function(t){return t}))).map((function(t){return i(t,f._options.actions)})),T,v),3),N=O[0],K=O[1],j=O[2],M=null!=h?h:p;return{value:M,context:K,actions:N,changed:h!==p||N.length>0||j,matches:o(M)}}}}catch(t){l={error:t}}finally{try{S&&!S.done&&(d=k.return)&&d.call(k)}finally{if(l)throw l.error}}}return c(p,T)}};return f}var d=function(t,e){return t.actions.forEach((function(n){var a=n.exec;return a&&a(t.context,e)}))};function m(t){var a=t.initialState,r=e.NotStarted,i=new Set,c={_machine:t,send:function(n){r===e.Running&&(a=t.transition(a,n),d(a,s(n)),i.forEach((function(t){return t(a)})))},subscribe:function(t){return i.add(t),t(a),{unsubscribe:function(){return i.delete(t)}}},start:function(i){if(i){var s="object"==typeof i?i:{context:t.config.context,value:i};a={value:s.value,actions:[],context:s.context,matches:o(s.value)}}return r=e.Running,d(a,n),c},stop:function(){return r=e.Stopped,i.clear(),c},get state(){return a},get status(){return r}};return c}const f=()=>{const t={};return{emit:(e,n)=>{var a;null===(a=t[e])||void 0===a||a.forEach((t=>t(n)))},off:(e,n)=>{const a=t[e];a&&(t[e]=a.filter((t=>t!==n)))},on:(e,n)=>{var a;const r=null!==(a=t[e])&&void 0!==a?a:[];r.push(n),t[e]=r}}};var p,T,v,g,y,k;!function(t){t.selectTask="SELECT_TASK",t.timerEnd="TIMER_END",t.transitionPomodoroState="TRANSITION_POMODORO_STATE"}(p||(p={})),function(t){t.initializing="INITIALIZING",t.selectTask="SELECT_TASK",t.task="TASK",t.taskTimerEndPrompt="TASK_TIMER_END_PROMPT",t.shortBreak="SHORT_BREAK",t.longBreak="LONG_BREAK"}(T||(T={})),function(t){t.initializing="INITIALIZING",t.selectTask="SELECT_TASK",t.task="TASK",t.taskTimerEndPrompt="TASK_TIMER_END_PROMPT"}(v||(v={})),function(t){t.createTimer="CREATE_TIMER",t.pauseTimer="PAUSE_TIMER",t.startTimer="START_TIMER",t.tickTimer="TICK_TIMER"}(g||(g={})),function(t){t.idle="IDLE",t.ready="READY",t.active="ACTIVE",t.paused="PAUSED"}(y||(y={})),function(t){t.task="TASK",t.shortBreak="SHORT_BREAK",t.longBreak="LONG_BREAK"}(k||(k={}));const S=({createTicker:t,settings:e})=>{const{emit:n,on:a,off:i}=f(),o=t(),s=(()=>{const{emit:t,on:e,off:n}=f(),a=[{target:T.selectTask,cond:(t,e)=>null===t.currentTaskId&&e.payload.target===T.task},{target:T.task,cond:(t,e)=>e.payload.target===T.task},{target:T.shortBreak,cond:(t,e)=>e.payload.target===T.shortBreak},{target:T.longBreak,cond:(t,e)=>e.payload.target===T.longBreak}],i=m(l({initial:T.initializing,context:{currentTaskId:null},states:{[T.initializing]:{on:{[p.transitionPomodoroState]:a}},[T.selectTask]:{on:{[p.selectTask]:{target:T.task,actions:r(((t,e)=>({currentTaskId:e.payload.taskId})))}}},[T.task]:{on:{[p.timerEnd]:T.taskTimerEndPrompt}},[T.taskTimerEndPrompt]:{}}}));let o=i.state;return i.subscribe((e=>{e.changed&&(o.value!==e.value&&(t("transition",{state:e,prevState:o}),o=e),t("update",e))})),i.start(),{handleTimerEnd:()=>{i.send(p.timerEnd)},selectTask:t=>{i.send({type:p.selectTask,payload:{taskId:t}})},transitionPomodoroState:t=>{i.send({type:p.transitionPomodoroState,payload:{target:t}})},getState:()=>i.state,on:e,off:n}})(),c=(()=>{const{emit:t,on:e,off:n}=f(),a=m(l({initial:y.idle,context:{timer:null},states:{[y.idle]:{entry:r({timer:null}),on:{[g.createTimer]:{target:y.ready,actions:r({timer:(t,e)=>{var n;return{isInjected:null!==(n=e.payload.isInjected)&&void 0!==n&&n,time:e.payload.time,totalTime:e.payload.time,type:e.payload.type}}})}}},[y.ready]:{on:{[g.startTimer]:y.active}},[y.active]:{on:{[g.tickTimer]:[{target:y.idle,cond:t=>1===t.timer.time},{actions:r({timer:t=>Object.assign(Object.assign({},t.timer),{time:t.timer.time-1})})}],[g.pauseTimer]:y.paused}},[y.paused]:{on:{[g.startTimer]:y.active}}}}));let i=a.state;return a.subscribe((e=>{e.changed&&(i.value!==e.value&&(t("transition",{state:e,prevState:i}),i=e),t("update",e))})),a.start(),{createTimer:t=>{a.send({type:g.createTimer,payload:t})},pauseTimer:()=>{a.send({type:g.pauseTimer})},startTimer:()=>{a.send(g.startTimer)},tickTimer:()=>{a.send(g.tickTimer)},getState:()=>a.state,on:e,off:n}})(),u=()=>{n("update",d())},d=()=>{const t=s.getState(),e=c.getState(),n=e.context.timer?{isActive:e.value===y.active,isInjected:e.context.timer.isInjected,isPaused:e.value===y.paused,time:e.context.timer.time,totalTime:e.context.timer.totalTime,type:e.context.timer.type}:null;return{value:t.value,currentTaskId:t.context.currentTaskId,timer:n}};return s.on("transition",(({state:t,prevState:a})=>{a.value===T.initializing?n("appInitialize",d()):t.value===T.task&&(c.createTimer({time:e.taskTime,type:k.task}),n("taskSelect",d()))})),s.on("update",u),c.on("transition",(({state:t,prevState:e})=>{t.value===y.active?(e.value===y.ready?n("timerStart",d()):e.value===y.paused&&n("timerResume",d()),o.start((()=>{c.tickTimer(),n("timerTick",d())}))):t.value===y.idle?(o.stop(),s.handleTimerEnd(),n("timerEnd",d())):t.value===y.paused&&(o.stop(),n("timerPause",d()))})),c.on("update",u),{pauseTimer:()=>{c.pauseTimer()},selectTask:t=>{s.selectTask(t)},setReady:()=>{(()=>{const t=e.set[0];let n;if("task"===t?n=T.task:"shortBreak"===t?n=T.shortBreak:"longBreak"===t&&(n=T.longBreak),!n)throw new Error(`Unknown set item: "${t}"`);s.transitionPomodoroState(n)})()},startTimer:()=>{c.startTimer()},getState:d,on:a,off:i}};export{S as default};
