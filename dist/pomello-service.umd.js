var t,e;t=this,e=function(){function t({initialState:t,context:e,onStateChange:n}){let i={value:t,context:e};return{getState:function(){return i},setState:function(t,e){i={value:null!=t?t:i.value,context:null!=e?e:i.context},n(i)}}}var e,n,i,a;!function(t){t.initializing="INITIALIZING",t.selectTask="SELECT_TASK",t.task="TASK",t.taskCompletePrompt="TASK_COMPLETE_PROMPT",t.taskVoidPrompt="TASK_VOID_PROMPT",t.taskTimerEndPrompt="TASK_TIMER_END_PROMPT",t.shortBreak="SHORT_BREAK",t.longBreak="LONG_BREAK"}(e||(e={})),function(t){t.idle="IDLE",t.active="ACTIVE"}(n||(n={})),function(t){t.idle="IDLE",t.ready="READY",t.active="ACTIVE",t.paused="PAUSED"}(i||(i={})),function(t){t.task="TASK",t.shortBreak="SHORT_BREAK",t.longBreak="LONG_BREAK"}(a||(a={}));const o=({onStateChange:e,onTimerEnd:n,onTimerTick:a,ticker:o})=>{const{getState:r,setState:s}=t({initialState:i.idle,context:{timer:null},onStateChange:e});function c(){o.start((()=>{!function(){const{timer:t}=r().context;t&&(1===t.time?(s(i.idle,{timer:null}),o.stop(),n(t)):s(null,{timer:Object.assign(Object.assign({},t),{time:t.time-1})}))}(),a()}))}return{createTimer:function({isInjected:t=!1,time:e,type:n}){s(i.ready,{timer:{isInjected:t,time:e,totalTime:e,type:n}})},destroyTimer:function(){s(i.idle,{timer:null}),o.stop()},pauseTimer:function(){s(i.paused),o.stop()},startTimer:function(){s(i.active),c()},getState:r}};return({createTicker:r,settings:s})=>{const{batchedEmit:c,emit:u,on:m,off:l}=(()=>{const t={},e=new Map;function n(e,n){var i;null===(i=t[e])||void 0===i||i.forEach((t=>t(n)))}return{batchedEmit:function(t,i){e.size>0?e.set(t,i):(e.set(t,i),setImmediate((function(){for(const[t,i]of e)n(t,i);e.clear()})))},emit:n,off:function(e,n){const i=t[e];i&&(t[e]=i.filter((t=>t!==n)))},on:function(e,n){var i;const a=null!==(i=t[e])&&void 0!==i?i:[];a.push(n),t[e]=a}}})(),T=function({onStateChange:n}){const{getState:i,setState:a}=t({initialState:e.initializing,context:{currentTaskId:null},onStateChange:n});return{completeTask:function(){a(e.taskCompletePrompt)},getState:i,selectTask:function(t){a(e.task,{currentTaskId:t})},setAppState:function(t){a(t)},switchTask:function(){a(e.selectTask,{currentTaskId:null})},unsetCurrentTask:function(){a(null,{currentTaskId:null})},voidTask:function(){a(e.taskVoidPrompt)}}}({onStateChange:p}),k=o({onStateChange:p,onTimerEnd:function(t){u("timerEnd",S(Object.assign(Object.assign({},t),{time:0}))),t.isInjected||g(),T.getState().value===e.task?T.setAppState(e.taskTimerEndPrompt):v(),f.startOvertimeCountdown({delay:s.overtimeDelay,type:t.type})},onTimerTick:function(){u("timerTick",S())},ticker:r()}),f=(({onStateChange:e,ticker:i})=>{const{getState:a,setState:o}=t({initialState:n.idle,context:{overtime:null},onStateChange:e});return{startOvertimeCountdown:function({delay:t,type:e}){i.wait((function(){o(n.active,{overtime:{time:t,type:e}})}),t)},getState:a}})({onStateChange:p,ticker:r()});let d=0;function p(){c("update",h())}function S(t){const e=t||k.getState().context.timer;return{taskId:T.getState().context.currentTaskId,timer:e?{time:e.time,totalTime:e.totalTime,type:e.type}:null,timestamp:Date.now()}}function g(){d+=1,d>=s.set.length&&(d=0)}function v(){const t=s.set[d];if("task"===t)return T.getState().context.currentTaskId?(k.getState().context.timer||k.createTimer({time:s.taskTime,type:a.task}),T.setAppState(e.task)):T.setAppState(e.selectTask);if("shortBreak"===t)return k.createTimer({time:s.shortBreakTime,type:a.shortBreak}),T.setAppState(e.shortBreak);if("longBreak"===t)return k.createTimer({time:s.longBreakTime,type:a.longBreak}),T.setAppState(e.longBreak);throw new Error(`Unknown set item: "${t}"`)}function h(){const t=T.getState(),e=k.getState(),n=f.getState(),a=e.context.timer?{isActive:e.value===i.active,isInjected:e.context.timer.isInjected,isPaused:e.value===i.paused,time:e.context.timer.time,totalTime:e.context.timer.totalTime,type:e.context.timer.type}:null;return{value:t.value,currentTaskId:t.context.currentTaskId,timer:a,overtime:n.context.overtime}}function I(){const t=k.getState().value===i.paused;k.startTimer(),u(t?"timerResume":"timerStart",S())}return{completeTask:function(){T.completeTask()},continueTask:function(){v(),I()},getState:h,off:l,on:m,pauseTimer:function(){k.pauseTimer(),u("timerPause",S())},selectNewTask:function(){T.unsetCurrentTask(),v(),I()},selectTask:function(t){T.selectTask(t),v(),u("taskSelect",S())},setReady:function(){v(),u("appInitialize",S())},skipTimer:function(){u("timerSkip",S()),k.destroyTimer(),g(),v()},startTimer:I,switchTask:function(){T.switchTask()},taskCompleteHandled:function(){T.unsetCurrentTask(),v()},voidTask:function(){u("taskVoid",S()),k.getState().value===i.active&&k.destroyTimer(),T.getState().value===e.taskTimerEndPrompt&&(d-=1,d<0&&(d=s.set.length-1)),T.voidTask()},voidPromptHandled:function(){T.setAppState(e.shortBreak),k.createTimer({isInjected:!0,time:s.shortBreakTime,type:a.shortBreak}),I()}}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).createPomelloService=e();
