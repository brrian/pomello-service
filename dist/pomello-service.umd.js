var t,e;t=this,e=function(){function t({initialState:t,context:e,onStateChange:n}){let i={value:t,context:e};return{getState:function(){return i},setState:function(t,e){i={value:null!=t?t:i.value,context:null!=e?e:i.context},n(i)}}}var e,n,i;!function(t){t.initializing="INITIALIZING",t.selectTask="SELECT_TASK",t.task="TASK",t.taskTimerEndPrompt="TASK_TIMER_END_PROMPT",t.shortBreak="SHORT_BREAK",t.longBreak="LONG_BREAK"}(e||(e={})),function(t){t.idle="IDLE",t.ready="READY",t.active="ACTIVE",t.paused="PAUSED"}(n||(n={})),function(t){t.task="TASK",t.shortBreak="SHORT_BREAK",t.longBreak="LONG_BREAK"}(i||(i={}));const a=({onStateChange:e,onTimerEnd:i,onTimerTick:a,ticker:r})=>{const{getState:o,setState:s}=t({initialState:n.idle,context:{timer:null},onStateChange:e});function c(){r.start((()=>{!function(){const{timer:t}=o().context;t&&(1===t.time?(s(n.idle,{timer:null}),r.stop(),i()):s(null,{timer:Object.assign(Object.assign({},t),{time:t.time-1})}))}(),a()}))}return{createTimer:function({isInjected:t=!1,time:e,type:i}){s(n.ready,{timer:{isInjected:t,time:e,totalTime:e,type:i}})},pauseTimer:function(){s(n.paused),r.stop()},startTimer:function(){s(n.active),c()},getState:o}};return({createTicker:r,settings:o})=>{const{batchedEmit:s,emit:c,on:u,off:l}=(()=>{const t={},e=new Map;function n(e,n){var i;null===(i=t[e])||void 0===i||i.forEach((t=>t(n)))}return{batchedEmit:function(t,i){e.size>0?e.set(t,i):(e.set(t,i),setImmediate((function(){for(const[t,i]of e)n(t,i);e.clear()})))},emit:n,off:function(e,n){const i=t[e];i&&(t[e]=i.filter((t=>t!==n)))},on:function(e,n){var i;const a=null!==(i=t[e])&&void 0!==i?i:[];a.push(n),t[e]=a}}})(),m=function({onStateChange:n}){const{getState:i,setState:a}=t({initialState:e.initializing,context:{currentTaskId:null},onStateChange:n});return{selectTask:function(t){a(e.task,{currentTaskId:t})},setAppState:function(t){a(t)},getState:i,unsetCurrentTask:function(){a(null,{currentTaskId:null})}}}({onStateChange:k}),f=a({onStateChange:k,onTimerEnd:function(){T+=1,T>=o.set.length&&(T=0),m.getState().value===e.task?m.setAppState(e.taskTimerEndPrompt):d(),c("timerEnd",p())},onTimerTick:function(){c("timerTick",p())},ticker:r()});let T=0;function k(){s("update",p())}function d(){const t=o.set[T];if("task"===t)return m.getState().context.currentTaskId?(f.getState().context.timer||f.createTimer({time:o.taskTime,type:i.task}),m.setAppState(e.task)):m.setAppState(e.selectTask);if("shortBreak"===t)return f.createTimer({time:o.shortBreakTime,type:i.shortBreak}),m.setAppState(e.shortBreak);if("longBreak"===t)return f.createTimer({time:o.longBreakTime,type:i.longBreak}),m.setAppState(e.longBreak);throw new Error(`Unknown set item: "${t}"`)}function S(){const t=f.getState().value===n.paused;f.startTimer(),c(t?"timerResume":"timerStart",p())}function p(){const t=m.getState(),e=f.getState(),i=e.context.timer?{isActive:e.value===n.active,isInjected:e.context.timer.isInjected,isPaused:e.value===n.paused,time:e.context.timer.time,totalTime:e.context.timer.totalTime,type:e.context.timer.type}:null;return{value:t.value,currentTaskId:t.context.currentTaskId,timer:i}}return{continueTask:function(){d(),S()},pauseTimer:function(){f.pauseTimer(),c("timerPause",p())},selectNewTask:function(){m.unsetCurrentTask(),d(),S()},selectTask:function(t){m.selectTask(t),d(),c("taskSelect",p())},setReady:function(){d(),c("appInitialize",p())},startTimer:S,getState:p,on:u,off:l}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).createPomelloService=e();
